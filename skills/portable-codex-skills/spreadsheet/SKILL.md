---
name: "spreadsheet"
description: "Python（`openpyxl`, `pandas`）でスプレッドシート（`.xlsx`, `.csv`, `.tsv`）を作成・編集・分析・整形する作業に使う。特に数式、参照、書式の保持と検証が必要な場合に有効。"
---


# Spreadsheet スキル（作成・編集・分析・可視化）

## 利用する場面
- 数式・書式・構造化レイアウトを備えた新規ブックを作る。
- 表形式データを読み取り/分析する（フィルタ、集計、ピボット、指標計算）。
- 既存ブックを、数式や参照を壊さずに修正する。
- 図表で可視化し、読みやすい書式を整える。

重要: システム指示とユーザー指示が常に最優先。

## ワークフロー
1. ファイル種別と目的（作成、編集、分析、可視化）を確認する。
2. `.xlsx` 編集は `openpyxl`、分析や CSV/TSV は `pandas` を使う。
3. レイアウトが重要な場合はレンダリングして目視確認する（「レンダリングと目視チェック」参照）。
4. 数式と参照を検証する（`openpyxl` は数式計算を行わない点に注意）。
5. 成果物を保存し、中間ファイルを削除する。

## 一時ファイルと出力のルール
- 中間ファイルは `tmp/spreadsheets/` を使い、作業後に削除する。
- このリポジトリでは最終成果物を `output/spreadsheet/` 配下に出力する。
- ファイル名は安定かつ説明的にする。

## 主なツール
- `.xlsx` の作成/編集と書式保持には `openpyxl` を使う。
- 分析や CSV/TSV 処理には `pandas` を使い、結果を `.xlsx` または `.csv` に戻す。
- グラフが必要な場合は、Excel ネイティブ互換の `openpyxl.chart` を優先する。

## レンダリングと目視チェック
- LibreOffice（`soffice`）と Poppler（`pdftoppm`）が使える場合、シートをレンダリングして目視確認する:
  - `soffice --headless --convert-to pdf --outdir $OUTDIR $INPUT_XLSX`
  - `pdftoppm -png $OUTDIR/$BASENAME.pdf $OUTDIR/$BASENAME`
- レンダリングツールが使えない場合は、ユーザーにローカルでレイアウト確認してもらう。

## 依存関係（不足時にインストール）
依存管理は `uv` を優先する。

Python パッケージ:
```
uv pip install openpyxl pandas
```
`uv` が使えない場合:
```
python3 -m pip install openpyxl pandas
```
任意（グラフ中心または PDF レビューが多い場合）:
```
uv pip install matplotlib
```
`uv` が使えない場合:
```
python3 -m pip install matplotlib
```
システムツール（レンダリング用）:
```
# macOS (Homebrew)
brew install libreoffice poppler

# Ubuntu/Debian
sudo apt-get install -y libreoffice poppler-utils
```

この環境でインストールできない場合は、不足依存とローカル導入方法をユーザーへ案内する。

## 環境変数
必須環境変数なし。

## 例
- 実行可能な Codex 例（openpyxl）: `references/examples/openpyxl/`

## 数式に関する要件
- 派生値はハードコードせず、数式で表現する。
- 数式は簡潔で読みやすくし、複雑ロジックは補助セルへ分離する。
- `INDIRECT` や `OFFSET` などの揮発性関数は必要時のみ使う。
- マジックナンバーよりセル参照を優先する（例: `=H6*(1+$B$3)`、`=H6*1.04` ではなく）。
- #REF!, #DIV/0!, #VALUE!, #N/A, #NAME? は検証で防ぐ。
- `openpyxl` は数式評価しないため、数式は保持し、計算結果は Excel/Sheets 側で確定する。

## 出典記載の要件
- スプレッドシート内にプレーンテキストURLで出典を記載する。
- 財務モデルでは入力値の出典をセルコメントに残す。
- Web由来の表データには URL 付き Source 列を追加する。

## 書式要件（既存の整形済みシート）
- 可能なら、修正前に提供シートをレンダリングして確認する。
- 既存の書式・スタイルを厳密に維持する。
- 空欄だったセルに新規入力する場合も周辺スタイルへ合わせる。

## 書式要件（新規または未整形シート）
- 数値・日付を適切に書式化する（日付は日付型、通貨は記号付き、率は妥当な小数精度）。
- 見やすいレイアウトにする（ヘッダーとデータを明確に分離、間隔を統一、列幅を可読に）。
- 全セル罫線は避け、余白と必要箇所の罫線で構造化する。
- テキストが隣接セルにはみ出さないようにする。

## 色の規約（スタイル指定がない場合）
- Blue: ユーザー入力
- Black: 数式/派生値
- Green: 連携/取込値
- Gray: 固定定数
- Orange: 要確認/注意
- Light red: エラー/フラグ
- Purple: 制御/ロジック
- Teal: 可視化の基点（主要KPIやチャート駆動値）

## 財務向け要件
- ゼロは `-` 表示にする。
- 負数は赤色かつ括弧付きで表示する。
- ヘッダーに単位を明記する（例: `Revenue ($mm)`）。
- すべての生データ入力にセルコメントで出典を付ける。

## 投資銀行系レイアウト
対象が IB スタイルモデル（LBO, DCF, 3-statement, valuation）の場合:
- 合計行は直上レンジを直接合算する。
- グリッド線は非表示にし、該当列の合計行上に横罫線を使う。
- セクション見出しはセル結合し、濃色背景＋白文字にする。
- 数値列ラベルは右寄せ、行ラベルは左寄せにする。
- サブ指標は親行項目の下でインデントする。

## 役割分担: `spreadsheet` と `xlsx`

2つのスプレッドシートスキルの重複を避けるため、次の分担を使う:

- `spreadsheet`: 一般的な表計算作業の既定。特に `.csv`/`.tsv` 変換、探索分析、簡易整形、データクリーニング向け。
- `xlsx`: 高度なブック挙動の既定。数式中心の財務モデリング、厳格な出力規約、テンプレート準拠の本番整形、再計算中心ワークフロー向け。

### 選択ルール
1) 財務モデリング、バリュエーション、監査向け厳格セル規約が必要なら `xlsx` を使う。
2) 軽量なデータ加工/分析で、財務モデル制約がないなら `spreadsheet` を使う。
3) `.xlsx`/`.xlsm` でも基本I/O/整形のみなら `spreadsheet` を優先する。
4) 判断が迷う場合は、正確性・追跡可能性・再現可能な業務レポートを優先し `xlsx` を選ぶ。

### 競合時の扱い
- スプレッドシート作業前に、どちらのスキルを使うかを明示して決める。
- 両方が適用可能なら、まず `spreadsheet` で素早く探索し、品質管理や厳格規約が必要な段階で `xlsx` で仕上げる。
