<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>経費精算ダッシュボード {{ ym }}</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <div>
          <p class="eyebrow">経費精算ダッシュボード</p>
          <h1>{{ ym }}</h1>
          <p class="subtitle">成果物の確認と除外・印刷（完了記録まで）の確定を行います。</p>
        </div>
        <div class="hero-meta">
          <a class="pill" href="/">ダッシュボードへ戻る</a>
        </div>
      </header>

      <section class="grid two">
        <div class="card">
          <h2>集計</h2>
          <div class="stats-grid">
            <div class="stat">
              <span class="label">未添付候補</span>
              <span class="value">{{ counts.get("mf_missing_evidence", 0) }}</span>
            </div>
            <div class="stat">
              <span class="label">MF経費</span>
              <span class="value">{{ counts.get("mf_expenses_in_month", 0) }}</span>
            </div>
            <div class="stat">
              <span class="label">Amazon注文</span>
              <span class="value">{{ counts.get("amazon_orders_in_month", 0) }}</span>
            </div>
            <div class="stat">
              <span class="label">楽天注文</span>
              <span class="value">{{ counts.get("rakuten_orders_in_month", 0) }}</span>
            </div>
            <div class="stat">
              <span class="label">除外件数</span>
              <span id="stat-excluded" class="value">{{ counts.get("excluded_orders", excluded_count) }}</span>
            </div>
            <div class="stat">
              <span class="label">対象件数</span>
              <span id="stat-included" class="value">{{ counts.get("included_orders", included_count) }}</span>
            </div>
            <div class="stat">
              <span class="label">Amazon PDF</span>
              <span class="value">{{ amazon_pdf_count }}</span>
            </div>
            <div class="stat">
              <span class="label">楽天 PDF</span>
              <span class="value">{{ rakuten_pdf_count }}</span>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>成果物ダウンロード</h2>
          {% if has_reports %}
          <div class="download-grid">
            <div class="download-card">
              <a href="/files/{{ ym }}/missing_csv" class="download">{{ file_labels.missing_csv }}</a>
              <div class="muted">MF未添付候補の一覧</div>
            </div>
            <div class="download-card">
              <a href="/files/{{ ym }}/missing_json" class="download">{{ file_labels.missing_json }}</a>
              <div class="muted">未添付候補の詳細データ</div>
            </div>
            <div class="download-card">
              <a href="/files/{{ ym }}/monthly_thread" class="download">{{ file_labels.monthly_thread }}</a>
              <div class="muted">月次の整理メモ</div>
            </div>
            <div class="download-card">
              <a href="/files/{{ ym }}/run_config" class="download">{{ file_labels.run_config }}</a>
              <div class="muted">実行に使ったURLなど</div>
            </div>
            <div class="download-card">
              <a href="/files/{{ ym }}/audit_log" class="download">{{ file_labels.audit_log }}</a>
              <div class="muted">実行・確認・印刷の操作履歴</div>
            </div>
            {% if mf_draft_actions_exists %}
            <div class="download-card">
              <a href="/files/{{ ym }}/mf_draft_actions" class="download">{{ file_labels.mf_draft_actions }}</a>
              <div class="muted">Step5（MF下書き作成）の行単位ログ</div>
            </div>
            {% endif %}
            <div class="download-card">
              <a href="/runs/{{ ym }}/archived-receipts" class="download">アーカイブ済み領収書一覧</a>
              <div class="muted">Step5で保存したアーカイブ内PDFの確認</div>
            </div>
            {% if print_script %}
            <div class="download-card">
              <a href="/files/{{ ym }}/print_script" class="download">{{ file_labels.print_script }}</a>
              <div class="muted">印刷用PowerShell</div>
            </div>
            {% endif %}
          </div>
          <div class="print-box">
            <div class="label">印刷について</div>
            <div class="muted">印刷の実行は「除外設定」カード内のボタンに統合しました。</div>
            <div class="muted">除外を変更した場合は、再度「保存して印刷対象を更新」を実行してください。</div>
            <div class="muted">モノクロ印刷はプリンタ側の既定設定に従います（印刷ダイアログで最終確認してください）。</div>
          </div>
          {% else %}
          <p class="muted">成果物がまだありません。</p>
          {% endif %}
        </div>
      </section>

      <section class="card" id="exclude-section" data-ym="{{ ym }}">
        <h2>除外設定・印刷（完了記録まで）</h2>
        <p class="muted">
          MFに入力しない／印刷しないものだけにチェックを付けて保存してください。保存後、自動で印刷リストを作成します（印刷は自動実行しません）。
          <br />印刷コマンドまたは印刷用PowerShellを手動実行し、印刷が完了したら「印刷完了を記録」を押してください。
          <br />この操作では不足PDFの再取得は行いません。不足がある場合は領収書取得ステップを再実行してください。
          <br />MFとの突合はこの画面では行いません（ダッシュボードのステップ5で実行します）。
        </p>
        <div class="form-row">
          <button
            type="button"
            class="primary exclude-save"
            data-source="amazon"
            data-print-ready="{{ 1 if amazon_bulk_print_ready else 0 }}"
          >
            Amazonで保存して印刷対象を更新
          </button>
          <button
            type="button"
            class="primary exclude-save"
            data-source="rakuten"
            data-print-ready="{{ 1 if rakuten_bulk_print_ready else 0 }}"
          >
            楽天で保存して印刷対象を更新
          </button>
          <button
            type="button"
            class="secondary print-complete"
            data-source="amazon"
            {% if not amazon_print_prepared %}disabled{% endif %}
          >
            Amazon印刷完了を記録
          </button>
          <button
            type="button"
            class="secondary print-complete"
            data-source="rakuten"
            {% if not rakuten_print_prepared %}disabled{% endif %}
          >
            楽天印刷完了を記録
          </button>
          <a class="secondary" href="/runs/{{ ym }}/excluded-pdfs">除外PDF一覧</a>
          <button type="button" class="secondary" id="open-receipts-folder" data-ym="{{ ym }}">領収書フォルダを開く</button>
          <span
            id="exclude-status"
            class="status-note"
            data-success="除外設定を保存しました。印刷対象の更新が完了しました。"
            data-error="保存または印刷対象の更新に失敗しました。ログを確認してください。"
          ></span>
          <span id="print-script-status" class="status-note"></span>
          <span id="exclude-summary" class="muted" data-orders-total="{{ orders_total }}">
            注文 {{ orders_total }} 件 / 除外 <span id="exclude-summary-count">{{ excluded_count }}</span> 件
          </span>
        </div>
        <div id="print-next-box" class="print-box hidden" aria-live="polite">
          <div class="label">次の操作（手動印刷）</div>
          <div id="print-next-summary" class="muted">印刷対象の更新後に、ここに次の手順を表示します。</div>
          <div class="print-actions">
            <a id="print-next-open" class="secondary" href="#" target="_blank" rel="noopener">除外PDF一覧を開く（1件ずつ印刷）</a>
            <div class="print-cmd" id="print-next-cmd"></div>
            <button type="button" class="copy-button" data-copy-target="print-next-cmd">コマンドをコピー</button>
          </div>
          <div class="muted">印刷ダイアログは自動では開きません。迷う場合は「除外PDF一覧」で1件ずつ印刷してください。</div>
          <div class="muted">モノクロ出力にする場合は印刷ダイアログで「白黒/グレースケール」を選択してください。</div>
        </div>
        {% if orders %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>除外</th>
                <th>種別</th>
                <th>注文日</th>
                <th>注文ID</th>
                <th>合計</th>
                <th>商品名</th>
                <th>状態</th>
                <th>PDF</th>
                <th>ショートカット</th>
              </tr>
            </thead>
            <tbody>
              {% for order in orders %}
              <tr>
                <td>
                  {% if order.can_toggle %}
                  <input
                    type="checkbox"
                    class="exclude-toggle"
                    data-source="{{ order.source }}"
                    data-order-id="{{ order.order_id }}"
                    {% if order.excluded %}checked{% endif %}
                  />
                  {% else %}
                  <span class="muted">{% if order.auto_excluded %}自動除外{% else %}-{% endif %}</span>
                  {% endif %}
                </td>
                <td>{{ order.source_label }}</td>
                <td>{{ order.order_date or "-" }}</td>
                <td>{{ order.order_id or "-" }}</td>
                <td>{{ order.total_yen or "-" }}</td>
                <td>{{ order.item_name or "-" }}</td>
                <td>{{ order.status_label }}</td>
                <td>
                  {% if order.has_pdf and order.pdf_name %}
                  <a href="/files/{{ ym }}/pdf/{{ order.source }}/{{ order.pdf_name }}" target="_blank" rel="noopener">プレビュー</a>
                  {% elif order.receipt_url or order.detail_url %}
                  <span class="muted">未保存（Webあり）</span>
                  {% else %}
                  なし
                  {% endif %}
                </td>
                <td>
                  {% if order.receipt_url %}
                  <a href="{{ order.receipt_url }}" target="_blank" rel="noopener">領収書ページ</a>
                  {% elif order.detail_url %}
                  <a href="{{ order.detail_url }}" target="_blank" rel="noopener">注文詳細</a>
                  {% else %}
                  なし
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="muted">注文データがありません。Amazon/楽天の取得を先に実行してください。</p>
        {% endif %}
      </section>

      <section class="card mf-draft-viewer" data-mf-draft-viewer data-ym="{{ ym }}">
        <h2>MF下書き作成ログ（Step5）</h2>
        <p class="muted">
          `reports/mf_draft_create_actions.jsonl` を読み取り、MF明細（mf_expense_id）ごとに作成/スキップ/失敗を一覧表示します。
          <br />失敗したものは `reason/detail` と `autofill` を見て原因を潰してください。
        </p>
        <div class="form-row">
          <label class="mf-draft-filter">
            <span>絞り込み</span>
            <input type="text" id="mf-draft-filter" placeholder="mf_expense_id / order_id / reason で検索" />
          </label>
          <button type="button" class="secondary" id="mf-draft-refresh">更新</button>
          <a class="secondary" id="mf-draft-download" href="/files/{{ ym }}/mf_draft_actions">JSONLをダウンロード</a>
          <span id="mf-draft-status" class="status-note"></span>
        </div>
        <div class="stats-grid mf-draft-stats" data-mf-draft-stats>
          <div class="stat">
            <span class="label">Targets</span>
            <span class="value" data-mf-draft-stat="targets">-</span>
          </div>
          <div class="stat">
            <span class="label">Created</span>
            <span class="value" data-mf-draft-stat="created">-</span>
          </div>
          <div class="stat">
            <span class="label">Skipped</span>
            <span class="value" data-mf-draft-stat="skipped">-</span>
          </div>
          <div class="stat">
            <span class="label">Failed</span>
            <span class="value" data-mf-draft-stat="failed">-</span>
          </div>
        </div>
        <div class="table-wrap">
          <table class="mf-draft-table">
            <thead>
              <tr>
                <th>状態</th>
                <th>MF ID</th>
                <th>利用日/金額</th>
                <th>摘要</th>
                <th>注文</th>
                <th>原因</th>
                <th>補完</th>
              </tr>
            </thead>
            <tbody id="mf-draft-table-body">
              <tr data-mf-draft-empty>
                <td colspan="7" class="muted">ログを読み込み中です。</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2>未添付候補（上位50件）</h2>
        <p class="muted">
          MFの未添付候補CSV/JSONから先頭50件を表示します。PDF取得や除外判断の目安にしてください。
          <br />ステータス: 取得済み=領収書あり / 領収書なし / 対象外 / 日付不明 / エラー / ギフト券
        </p>
        {% if rows %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>利用日</th>
                <th>金額</th>
                <th>摘要 / メモ</th>
                <th>紐付け（注文ID / 日付 / 金額）</th>
              </tr>
            </thead>
            <tbody>
              {% for row in rows %}
              <tr>
                <td>{{ row.mf_use_date }}</td>
                <td>{{ row.mf_amount_label }}</td>
                <td class="wide">{{ row.mf_summary }}</td>
                <td>
                  {% if row.order_id %}
                  {% if row.order_source == "amazon" %}Amazon{% elif row.order_source == "rakuten" %}楽天{% else %}{{ row.order_source }}{% endif %}
                  / {{ row.order_date }} / {{ row.total_yen }}
                  {% else %}
                  未突合
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="muted">全 {{ row_total }} 件。CSV/JSONに全文があります。</p>
        {% else %}
        <p class="muted">未添付候補がありません。</p>
        {% endif %}
      </section>
    </div>
    <div id="toast" class="toast" aria-live="polite"></div>
    <script src="/static/js/common.js"></script>
    <script src="/static/js/run.js"></script>
  </body>
</html>



