# MFクラウド経費: 操作ナレッジ（Step0/Step5の前提理解）

この資料は、当リポジトリの自動化（Step0: preflight / Step5: 下書き作成）に必要な周辺知識を、
MFクラウド経費の公式ガイドに寄せて整理したものです。

## 1. 用語対応（このスキル内の呼び方）

- Step0: MFの連携サービス更新（「取得中」表示が出るところまで）
- Step5: `outgo_input` 上の連携明細に対して「編集登録」を開き、領収書PDFを添付して「作成する」で下書きを作る
- MF明細ID: `mf_expense_id`（スキル側の突合結果から採番される識別子）

## 2. 対象ページ（MFの操作導線）

### 2.1 個人設定 > 連携サービス

- 連携サービス一覧にカードが並ぶ。
- 各カード右上の三点リーダ（横三点）メニューから「再取得」を実行できる。
- 目視の成功判定は「取得中」表示が出ること（完了の検証は Step5 の突合で担保）。

### 2.2 連携サービスから登録（= outgo_input 相当）

公式ガイドでは「連携サービスから登録」画面で、連携済みかつ未登録の明細が一覧になる。編集登録/登録/対象外がある。

本スキルの Step5 は、この「編集登録」導線に相当する操作を自動化する。

## 3. 必須項目とバリデーション（Step5で詰まりやすいポイント）

### 3.1 経費科目（必須）

公式ガイド上、「経費科目は必須で、空欄の場合は明細登録できないため、編集登録で経費科目を選択する」旨が明記されている。
連携明細の初回は経費科目が空欄になり得るため、Step5 側での補完対象になりやすい。

### 3.2 支払先・内容 / 日付 / 金額（税込）（必須）

公式ガイド上、経費明細登録における必須項目として「支払先・内容」「日付」「経費科目」「金額」が繰り返し登場する。
連携サービス経由の場合は、日付/支払先内容/金額が取り込まれる想定だが、例外的に欠落するケースはあり得る。

### 3.3 部門 / プロジェクト / 税区分 など（テナント設定依存）

会社（管理者）設定によっては、部門/プロジェクト/税区分/貸方科目等が必須または編集不可になり得る。
従業員側で設定できる「入力フォーム > 経費入力初期値」により、部門/プロジェクト/貸方科目等の初期値を持たせられる。

Step5 で `validation_failed` が出た場合は、
ダッシュボードの「MF下書き作成ログ（Step5）」で `validation:` の文言を確認し、どの項目が必須になっているかを特定する。
恒久対策として MF 側の初期値設定（入力フォーム）を使うのが最も安定する。

## 4. OCR入力（領収書読み取り）と自動入力の期待値

### 4.1 OCR入力で読み取れる項目

公式FAQでは、領収書画像をアップロードすると「日付」「支払先」「金額」「適格請求書発行事業者登録番号」等を読み取る旨が説明されている。

### 4.2 部門/プロジェクトの自動入力

公式FAQでは、部門/プロジェクトは（従業員画面の初期値設定等により）自動入力され得る旨が言及されている。
当スキルの Step5 は、MF側の初期値や自動入力が効いていない場合に備えて、バリデーション失敗時に select を補完する。

## 5. 当スキルのログ設計（現物確認で見る場所）

### 5.1 行単位ログ（MF下書き作成）

- `reports/mf_draft_create_actions.jsonl`
  - `target_start` / `matching_row_found` / `create_validation_failed` / `autofill_required_fields` / `target_created` / `target_failed` 等
  - `create_validation_failed.errors` は、MF画面のエラー文言をそのまま残す（後で補完ロジックの強化に使う）

### 5.2 デバッグスナップショット

- `_runs/*.log`: 実行全体のログ
- `debug/mfcloud_draft/`: 失敗時の html/png（自動化が「どこで詰まったか」を再現できる）

## 6. スキルの実装側メモ（操作の安全策）

- すでに MF側で領収書が添付されている場合は、再添付しない（重複添付の防止）
- `validation_failed` のときは、エラー文言から「経費科目/部門/プロジェクト/税区分」等の不足を推定して補完を試みる
- 最終的に埋め切れない必須項目がある場合は失敗としてログに残し、処理自体は継続する

## 7. 公式情報ソース（リンク集）

下記は本資料の根拠として参照した公式ページ。

- 経費明細登録手順（Web）: https://biz.moneyforward.com/support/expense/guide/ap/ap31.html
- 入力フォーム（個人設定）: https://biz.moneyforward.com/support/expense/guide/personal/pa34.html
- OCR入力（自動読み取り）FAQ: https://biz.moneyforward.com/support/expense/faq/ap-faq/r10.html
- 税区分/勘定科目/経費科目等の設定（STEP2 経費機能設定）: https://biz.moneyforward.com/support/expense/guide/first-step-guide/fs02.html

