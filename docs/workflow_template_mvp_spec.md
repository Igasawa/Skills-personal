# ワークフロー作成テンプレート MVP仕様書

- 作成日: 2026-02-18
- 版: v0.1 (MVP)
- 対象: 手順定義カードUIの再設計

## 1. 目的

手順定義をゼロベースで見直し、ワークスペースの「追加リンクカード」に近い操作感で、カード内に小単位のタスクカードを追加・編集・並び替えできるMVPを作る。

## 2. MVPスコープ

### 2.1 対象(含む)

1. 親カード(ワークフローカード)の中でタスクカードを追加できる。
2. タスクカードに表示番号(1,2,3...)を表示する。
3. タスクカードをドラッグ&ドロップで並び替えできる。
4. 各タスクカードに `自動実行` トグルを持つ。
5. 各タスクカードに `タイマー入力UI` を持つ。
6. 最小実行ログ(成功/失敗/実行時刻)を保持・表示できる。

### 2.2 非対象(含まない)

1. タイマーによる実ジョブ実行(スケジューラ連携)。
2. 条件分岐、ループ、ネストされた子タスク。
3. 外部システム実行連携(例: Playwright実行、バッチ起動)。
4. 通知、権限管理、承認フロー。

## 3. 画面要件

## 3.1 親カード(ワークフローカード)

表示項目:

1. テンプレート名(必須)
2. 説明(任意)
3. `+ タスクを追加` ボタン
4. タスクカード一覧エリア

操作:

1. 親カードは1画面内で完結して編集可能。
2. `+ タスクを追加` でタスクカードを末尾に追加。

## 3.2 タスクカード(小単位)

表示項目:

1. ドラッグハンドル
2. 表示番号 (`Task 1`, `Task 2` など)
3. タスク名(必須)
4. `自動実行` トグル (`ON/OFF`)
5. タイマー入力UI(分)  
   注: UIのみ。MVPでは実行されない。
6. 削除ボタン
7. 最新実行ログ表示(任意表示、最低限1件)

操作:

1. タスク名の編集
2. `自動実行` トグル切替
3. タイマー値入力
4. 削除
5. DnDで並び替え

## 4. データ仕様(MVP)

## 4.1 ルート

```json
{
  "templateId": "tpl_xxx",
  "name": "経費精算 月次手順",
  "description": "MVP template",
  "steps": []
}
```

## 4.2 タスクカード

```json
{
  "stepUid": "stp_01H...",
  "order": 1,
  "title": "明細を確認",
  "autoRun": false,
  "timerMinutes": null,
  "executionLog": [
    {
      "executedAt": "2026-02-18T09:30:00+09:00",
      "result": "success",
      "message": "manual test"
    }
  ]
}
```

項目定義:

1. `stepUid`: 永続ID。作成時に採番し、並び替え後も不変。
2. `order`: 表示順。並び替え時に再計算して保存。
3. `title`: タスク名。必須。
4. `autoRun`: 自動実行フラグ。MVPでは設定保存のみ。
5. `timerMinutes`: タイマーUI入力値。MVPでは設定保存のみ。
6. `executionLog`: 最小実行ログ(成功/失敗/時刻)。MVPは表示・保持のみ。

## 5. 業務ルール/バリデーション

1. 表示番号は `order` から毎回再計算する(永続しない)。
2. `stepUid` は内部管理用で、表示番号とは分離する。
3. `title` は必須、最大80文字。
4. `autoRun = ON` のとき `timerMinutes` は必須。
5. `timerMinutes` は整数、範囲 `1-10080` (1分-7日)。
6. DnD完了時に `order` を 1..N へ振り直す。
7. タスク0件保存は禁止(最低1件必要)。

## 6. DnD仕様

1. ドラッグ開始はハンドル操作のみ。
2. ドロップ確定後、即時に並び順を反映する。
3. 並び替え後に以下を同時更新:
   - `order`
   - 表示番号
4. 並び替えで `stepUid` は変更しない。

## 7. タイマー仕様(UIのみ)

1. `自動実行` が `OFF` の場合、タイマー入力は非活性表示。
2. `自動実行` が `ON` の場合、タイマー入力を活性化。
3. 保存時に値は保持するが、実行ジョブは作成しない。
4. 画面文言に `MVPでは自動実行されません` を表示する。

## 8. 実行ログ仕様(最小)

1. ログ項目: `executedAt`, `result(success|failed)`, `message`。
2. タスクカードに最新1件を表示(例: `成功 2026-02-18 09:30`)。
3. 詳細履歴UIはMVP対象外(保持のみ)。

## 9. 受け入れ基準

1. タスクを3件追加すると表示番号が `1,2,3` になる。
2. 3番を先頭へD&Dすると表示番号が `1,2,3` に再計算される。
3. 並び替え前後で各タスクの `stepUid` は不変。
4. `autoRun=ON` かつタイマー未入力で保存しようとするとエラーになる。
5. `autoRun=OFF` ではタイマー未入力でも保存できる。
6. 画面上に `タイマーはMVPでは実行されない` 旨が表示される。
7. 最新実行ログが存在する場合、タスクカードに1件表示される。

## 10. 実装ステップ(推奨順)

1. 親カード + タスクカードのCRUDを実装。
2. `stepUid` と `order` 分離モデルを実装。
3. DnD並び替え + 連番再計算を実装。
4. `autoRun`/`timerMinutes` のUIとバリデーションを実装(実行処理なし)。
5. 最小実行ログの表示を実装。

## 11. 将来拡張(参考)

1. タイマー実行のバックエンド連携(ジョブキュー/スケジューラ)。
2. 条件分岐(成功時のみ次へ、失敗時停止など)。
3. 通知連携(Slack/メール)。
4. テンプレート複製とバージョン管理。
